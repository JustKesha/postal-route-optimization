<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Оптимизация авиамаршрутов для почтовых отправлений</title>
    <link rel="icon" href="icon.svg" type="image/svg+xml">
    <style>
        :root {
            --primary-color: #0054a6; /* Основной синий цвет */
            --secondary-color: #e6f0fa; /* Светло-синий фон */
            --text-color: #333; /* Основной цвет текста */
            --light-text: #666; /* Светлый текст */
            --border-radius: 8px; /* Скругление углов */
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); /* Тень элементов */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .custom-font {
            font-family: "Raleway", sans-serif;
            font-optical-sizing: auto;
        }

        body {
            background-color: #f9f9f9;
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: white;
            padding: 20px 0;
            box-shadow: var(--box-shadow);
            margin-bottom: 30px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            color: var(--primary-color);
            font-size: 24px;
            font-weight: 700;
        }

        .noselect {
        -webkit-touch-callout: none; /* iOS Safari */
            -webkit-user-select: none; /* Safari */
            -khtml-user-select: none; /* Konqueror HTML */
            -moz-user-select: none; /* Old versions of Firefox */
                -ms-user-select: none; /* Internet Explorer/Edge */
                    user-select: none; /* Non-prefixed version, currently
                                        supported by Chrome, Edge, Opera and Firefox */
        }
        
        .logo-svg {
            width: 32px;
            height: 32px;
            filter: brightness(0) saturate(100%) invert(22%) sepia(99%) saturate(2035%) hue-rotate(197deg) brightness(93%) contrast(101%);
            transform: scale(1.2);
            margin-right: 15px;
        }

        .header-links {
            display: flex;
            gap: 20px;
        }

        .header-links a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            transition: opacity 0.3s;
        }

        .header-links a:hover {
            opacity: 0.8;
            text-decoration: underline;
        }

        h1 {
            color: var(--primary-color);
            margin-bottom: 20px;
            text-align: center;
        }

        .description {
            text-align: center;
            margin-bottom: 30px;
            color: var(--light-text);
        }

        .app-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .input-section {
            flex: 1;
            min-width: 300px;
            background-color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .visualization-section {
            flex: 2;
            min-width: 400px;
            background-color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            display: flex;
            flex-direction: column;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        select, input, button {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 16px;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
            margin-top: 10px;
        }

        button:hover {
            background-color: #003d7a;
        }

        .delivery-param-tags {
            opacity: .75;
        }

        .delivery-param-tag-1 {
            margin-right: 6px;
        }

        .delivery-param-tag-2 {
            margin-right: 11px;
        }

        .delivery-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .delivery-item select {
            flex: 2;
        }

        .delivery-item input {
            flex: 1;
        }

        .remove-btn {
            flex: 0 0 45px;
            background-color: #ff4444;
            height: 45px;
            margin: 0;
        }

        .add-btn {
            margin-top: 0;
            background-color: #4CAF50;
        }

        .add-btn:hover {
            background-color: #3e8e41;
        }

        .btn-icon {
            display: inline-block;
            margin-right: 5px;
        }

        #map {
            width: 100%;
            height: 400px;
            background-color: var(--secondary-color);
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .city-point {
            position: absolute;
            width: 12px;
            height: 12px;
            background-color: var(--primary-color);
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }

        .city-label {
            position: absolute;
            font-size: 12px;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 2px 5px;
            border-radius: 3px;
            pointer-events: none;
        }

        .route-line {
            position: absolute;
            height: 2px;
            background-color: var(--primary-color);
            transform-origin: left center;
            z-index: 1;
        }

        .plane-icon {
            position: absolute;
            width: 16px;
            height: 16px;
            background-color: #ff5722;
            border-radius: 50%;
            z-index: 2;
            transform: translate(-50%, -50%);
        }

        .results {
            margin-top: 20px;
            padding: 15px;
            background-color: var(--secondary-color);
            border-radius: var(--border-radius);
        }

        .result-item strong {
            color: var(--primary-color);
        }

        .loading {
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--primary-color);
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        .result-items {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 20px;
        }

        .result-item {
            display: flex;
            align-items: flex-start;
            gap: 7.5px;
        }

        .result-icon {
            flex-shrink: 0;
            width: 26px;
            height: 26px;
            color: var(--primary-color);
            opacity: 0.9;
            margin-top: 2px;
            transform: translateY(-3.5px);
        }

        .result-text {
            flex-grow: 1;
            line-height: 1.4;
        }

        #optimal-route {
            display: inline-block;
            margin-top: 6px;
            padding: 8px;
            background-color: rgba(0, 84, 166, 0.1);
            border-radius: var(--border-radius);
            line-height: 1.5;
        }

        .hidden {
            display: none;
        }

        /* Мобильная версия */
        @media (max-width: 1080px) {
            .header-content {
                display: block;
                padding-bottom: 0;
            }

            .logo {
                margin-bottom: 20px;
            }
        }

        /* Очень маленькие экраны */
        @media (max-width: 600px) {
            .header-links {
                display: block;
            }
            .header-links a {
                display: block;
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Raleway:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
</head>
<body>
    <header>
        <div class="container header-content">
            <div class="logo noselect custom-font">
                <img src="icon.svg" alt="Самолет" class="logo-svg">
                Оптимизация авиамаршрутов
            </div>
            <div class="header-links">
                <a href="https://translated.turbopages.org/proxy_u/en-ru.ru.1f95b4fe-684eb5e8-dd487bda-74722d776562/https/en.wikipedia.org/wiki/Trajectory_optimization" target="_blank">
                    Оптимизация маршрутов
                </a>
                <a href="https://ru.wikipedia.org/wiki/Логистика" target="_blank">
                    Основы логистики
                </a>
                <a href="https://ru.wikipedia.org/wiki/Метод_роя_частиц" target="_blank">
                    О методе PSO
                </a>
            </div>
        </div>
    </header>

    <div class="container">
        <h1 class="custom-font">Оптимизация маршрутов авиарейсов для почтовых отправлений</h1>
        <p class="description custom-font">Используйте роевой интеллект для построения оптимальных маршрутов доставки почтовых отправлений!</p>

        <div class="app-container">
            <div class="input-section">
                <div class="form-group">
                    <label for="start-city">Город отправления:</label>
                    <select id="start-city" class="noselect">
                        <!-- Города будут добавлены через JS -->
                    </select>
                </div>

                <div class="form-group">
                    <label>Параметры отправлений:</label>
                    <div id="deliveries-container">
                        <div class="delivery-param-tags">
                            <span class="delivery-param-tag-1">П. Назначения</span>
                            <span class="delivery-param-tag-2">Габариты (м³)</span>
                            <span class="delivery-param-tag-3">Вес (кг)</span>
                        </div>
                        <div class="delivery-item">
                            <select class="destination-city">
                                <!-- Города будут добавлены через JS -->
                            </select>
                            <select class="size">
                                <option value="small">Маленький (0.1 м³)</option>
                                <option value="medium" selected>Средний (0.3 м³)</option>
                                <option value="large">Большой (0.6 м³)</option>
                                <option value="xlarge">Очень большой (1 м³)</option>
                            </select>
                            <input type="number" class="weight" min="1" value="100" placeholder="Вес (кг)">
                            <button class="remove-btn noselect">
                                ✕
                            </button>
                        </div>
                    </div>
                    <button id="add-destination" class="add-btn noselect custom-font">
                        <div class="btn-icon">
                            ✚
                        </div>
                        Добавить пункт
                    </button>
                </div>

                <div class="form-group">
                    <label for="plane-capacity">Грузоподъемность самолета (кг):</label>
                    <input type="number" id="plane-capacity" min="100" value="1000">
                </div>
                
                <div class="form-group">
                    <label for="plane-volume">Вместимость самолета (м³):</label>
                    <select id="plane-volume">
                        <option value="10">Малый (10 м³)</option>
                        <option value="30" selected>Средний (30 м³)</option>
                        <option value="60">Большой (60 м³)</option>
                        <option value="100">Очень большой (100 м³)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="plane-capacity">Стоимость перелета (за 1 км):</label>
                    <input type="number" id="flight-cost" min="0" value="100">
                </div>

                <div class="form-group">
                    <label for="algorithm">Алгоритм оптимизации:</label>
                    <select id="algorithm" class="noselect">
                        <option value="pso">Роевой алгоритм (PSO)</option>
                        <option value="aco">Муравьиный алгоритм</option>
                    </select>
                </div>

                <button id="build-route" class="noselect custom-font">
                    <div class="btn-icon">
                        ✓
                    </div>
                    Построить маршрут
                </button>
            </div>

            <div class="visualization-section">
                <div id="map"></div>
                <div id="loading" class="loading hidden">
                    <div class="spinner"></div>
                    <p>Идет расчет оптимального маршрута...</p>
                </div>
                <div id="results" class="results hidden">
                    <h3>Результаты оптимизации маршрута</h3>
                    <div class="result-items">
                        <div class="result-item">
                            <svg class="result-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><circle cx="12" cy="5" r="3"/><path d="M6.5 8a2 2 0 0 0-1.905 1.46L2.1 18.5A2 2 0 0 0 4 21h16a2 2 0 0 0 1.925-2.54L19.4 9.5A2 2 0 0 0 17.48 8Z"/></g></svg>
                            <div class="result-text">
                                <strong>Общий вес:</strong> <span id="total-weight">0</span> кг
                            </div>
                        </div>
                        <div class="result-item">
                            <svg class="result-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M6.36 18.78L6.61 21l1.62-1.54l2.77-7.6c-.68-.17-1.28-.51-1.77-.98zm8.41-7.9c-.49.47-1.1.81-1.77.98l2.77 7.6L17.39 21l.26-2.22zm.17-2.28c.3-1.56-.6-2.94-1.94-3.42V4c0-.55-.45-1-1-1s-1 .45-1 1v1.18C9.84 5.6 9 6.7 9 8c0 1.84 1.66 3.3 3.56 2.95c1.18-.22 2.15-1.17 2.38-2.35M12 9c-.55 0-1-.45-1-1s.45-1 1-1s1 .45 1 1s-.45 1-1 1"/></svg>
                            <div class="result-text">
                                <strong>Общее расстояние:</strong> <span id="total-distance">0</span> км
                            </div>
                        </div>
                        <div class="result-item">
                            <svg class="result-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.5 4.5v4.667a.6.6 0 0 1-.282.51l-7.436 4.647a.6.6 0 0 0-.282.508v.9a.6.6 0 0 0 .746.582l6.508-1.628a.6.6 0 0 1 .746.582v2.96a.6.6 0 0 1-.205.451l-2.16 1.89c-.458.402-.097 1.151.502 1.042l3.256-.591a.6.6 0 0 1 .214 0l3.256.591c.599.11.96-.64.502-1.041l-2.16-1.89a.6.6 0 0 1-.205-.452v-2.96a.6.6 0 0 1 .745-.582l6.51 1.628a.6.6 0 0 0 .745-.582v-.9a.6.6 0 0 0-.282-.508l-7.436-4.648a.6.6 0 0 1-.282-.509V4.5a1.5 1.5 0 0 0-3 0"/></svg>
                            <div class="result-text">
                                <strong>Количество рейсов:</strong> <span id="flights-count">0</span>
                            </div>
                        </div>
                        <div class="result-item">
                            <svg class="result-icon" viewBox="0 0 24 24" width="24" height="24">
                                <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 13V9m9-3l-2-2m-9-2h4m-2 19a8 8 0 1 1 0-16a8 8 0 0 1 0 16"/>
                            </svg>
                            <div class="result-text">
                                <strong>Примерное время доставки:</strong> <span id="delivery-time">0</span> часов
                            </div>
                        </div>
                        <div class="result-item">
                            <svg class="result-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path d="M2 7a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2z"/><circle cx="12" cy="12" r="3"/><path d="M2 9a4 4 0 0 0 4-4v0m12 14a4 4 0 0 1 4-4v0"/></g></svg>
                            <div class="result-text">
                                <strong>Примерная стоимость:</strong> <span id="delivery-cost">0</span> руб.
                            </div>
                        </div>
                        <div class="result-item">
                            <svg class="result-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M6.016 4.502A2.976 2.976 0 0 0 3.038 7.48c0 2.233 2.978 5.53 2.978 5.53s2.978-3.297 2.978-5.53a2.976 2.976 0 0 0-2.978-2.978m0 4.041A1.063 1.063 0 1 1 7.079 7.48a1.064 1.064 0 0 1-1.063 1.063m15.008 2.753v-4.3a4.962 4.962 0 0 0-.204-1.333a4.996 4.996 0 0 0-9.796 1.216v.248l-.01.87v9.952h-.004v.041a2 2 0 0 1-4 0c0-.012.003-.024.004-.037H7.01V16.01h-2v2h.002a3.998 3.998 0 0 0 7.996-.005h.002v-.982h.005V8.997l.01-1.87V6.88a3.001 3.001 0 0 1 6 .123v4.275a1.999 1.999 0 1 0 2 .018"/></svg>
                            <div class="result-text">
                                <strong>Оптимальный маршрут:</strong><br>
                                <span id="optimal-route"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // База данных городов с их координатами (для визуализации)
        const cities = [
            { name: "Москва", lat: 55.7558, lng: 37.6173, airport: "Шереметьево" },
            { name: "Санкт-Петербург", lat: 59.9343, lng: 30.3351, airport: "Пулково" },
            { name: "Новосибирск", lat: 55.0084, lng: 82.9357, airport: "Толмачёво" },
            { name: "Екатеринбург", lat: 56.8389, lng: 60.6057, airport: "Кольцово" },
            { name: "Казань", lat: 55.7961, lng: 49.1064, airport: "Казань" },
            { name: "Нижний Новгород", lat: 56.3269, lng: 44.0065, airport: "Стригино" },
            { name: "Челябинск", lat: 55.1644, lng: 61.4368, airport: "Баландино" },
            { name: "Самара", lat: 53.1951, lng: 50.1018, airport: "Курумоч" },
            { name: "Омск", lat: 54.9914, lng: 73.3645, airport: "Омск" },
            { name: "Ростов-на-Дону", lat: 47.2224, lng: 39.7187, airport: "Платов" },
            { name: "Уфа", lat: 54.7351, lng: 55.9587, airport: "Уфа" },
            { name: "Красноярск", lat: 56.0184, lng: 92.8672, airport: "Емельяново" },
            { name: "Пермь", lat: 58.0105, lng: 56.2294, airport: "Большое Савино" },
            { name: "Воронеж", lat: 51.672, lng: 39.1843, airport: "Воронеж" },
            { name: "Волгоград", lat: 48.7071, lng: 44.5169, airport: "Гумрак" },
            { name: "Краснодар", lat: 45.0355, lng: 38.9753, airport: "Пашковский" },
            { name: "Саратов", lat: 51.5336, lng: 46.0343, airport: "Гагарин" },
            { name: "Тюмень", lat: 57.1522, lng: 65.5272, airport: "Рощино" },
            { name: "Тольятти", lat: 53.5078, lng: 49.4204, airport: "Курумоч" },
            { name: "Ижевск", lat: 56.8527, lng: 53.2115, airport: "Ижевск" }
        ];
        
        // Размеры посылок (м³)
        const packageSizes = {
            small: 0.1,
            medium: 0.3,
            large: 0.6,
            xlarge: 1
        };

        // Матрица расстояний между городами (в км)
        // В реальном приложении можно было бы вычислять расстояния по координатам
        const distanceMatrix = {};

        // Инициализация матрицы расстояний
        function initDistanceMatrix() {
            for (let i = 0; i < cities.length; i++) {
                distanceMatrix[cities[i].name] = {};
                for (let j = 0; j < cities.length; j++) {
                    if (i === j) {
                        distanceMatrix[cities[i].name][cities[j].name] = 0;
                    } else {
                        // Вычисляем примерное расстояние по координатам (упрощенная формула)
                        const lat1 = cities[i].lat;
                        const lng1 = cities[i].lng;
                        const lat2 = cities[j].lat;
                        const lng2 = cities[j].lng;
                        
                        // Формула гаверсинусов для расчета расстояния между точками на сфере
                        const R = 6371; // Радиус Земли в км
                        const dLat = (lat2 - lat1) * Math.PI / 180;
                        const dLng = (lng2 - lng1) * Math.PI / 180;
                        const a = 
                            Math.sin(dLat/2) * Math.sin(dLat/2) +
                            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                            Math.sin(dLng/2) * Math.sin(dLng/2);
                        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                        const distance = R * c;
                        
                        distanceMatrix[cities[i].name][cities[j].name] = Math.round(distance);
                    }
                }
            }
        }

        // Инициализация интерфейса
        function initUI() {
            const startCitySelect = document.getElementById('start-city');
            const destinationSelect = document.querySelector('.destination-city');
            
            // Заполняем выпадающие списки городами
            cities.forEach(city => {
                const option1 = document.createElement('option');
                option1.value = city.name;
                option1.textContent = city.name;
                startCitySelect.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = city.name;
                option2.textContent = city.name;
                destinationSelect.appendChild(option2.cloneNode(true));
            });
            
            // Устанавливаем Москву по умолчанию
            startCitySelect.value = "Москва";
            
            // Обработчик добавления нового пункта назначения
            document.getElementById('add-destination').addEventListener('click', () => {
                const container = document.getElementById('deliveries-container');
                const newItem = document.querySelector('.delivery-item').cloneNode(true);
                newItem.querySelector('.weight').value = '100';
                container.appendChild(newItem);
                
                // Добавляем обработчик удаления для новой кнопки
                newItem.querySelector('.remove-btn').addEventListener('click', () => {
                    if (document.querySelectorAll('.delivery-item').length > 1) {
                        container.removeChild(newItem);
                    } else {
                        alert('Должен остаться хотя бы один пункт назначения');
                    }
                });
            });
            
            // Обработчик удаления для первой кнопки
            document.querySelector('.remove-btn').addEventListener('click', (e) => {
                if (document.querySelectorAll('.delivery-item').length > 1) {
                    e.target.closest('.delivery-item').remove();
                } else {
                    alert('Должен остаться хотя бы один пункт назначения');
                }
            });
            
            // Обработчик построения маршрута
            document.getElementById('build-route').addEventListener('click', buildRoute);
            
            // Инициализируем карту
            initMap();
        }

        // Инициализация карты для визуализации
        function initMap() {
            const map = document.getElementById('map');
            const width = map.offsetWidth;
            const height = map.offsetHeight;
            
            // Находим минимальные и максимальные координаты для масштабирования
            const lngs = cities.map(city => city.lng);
            const lats = cities.map(city => city.lat);
            const minLng = Math.min(...lngs);
            const maxLng = Math.max(...lngs);
            const minLat = Math.min(...lats);
            const maxLat = Math.max(...lats);
            
            // Функция для преобразования координат в пиксели на карте
            function project(lng, lat) {
                const x = ((lng - minLng) / (maxLng - minLng)) * (width - 40) + 20;
                const y = height - ((lat - minLat) / (maxLat - minLat)) * (height - 40) - 20;
                return { x, y };
            }
            
            // Добавляем города на карту
            cities.forEach(city => {
                const pos = project(city.lng, city.lat);
                
                // Точка города
                const point = document.createElement('div');
                point.className = 'city-point';
                point.style.left = `${pos.x}px`;
                point.style.top = `${pos.y}px`;
                point.setAttribute('data-city', city.name);
                map.appendChild(point);
                
                // Название города
                const label = document.createElement('div');
                label.className = 'city-label';
                label.textContent = city.name;
                label.style.left = `${pos.x + 10}px`;
                label.style.top = `${pos.y - 10}px`;
                map.appendChild(label);
            });
            
            // Сохраняем функцию проекции для использования в других функциях
            map.project = project;
        }

        // Роевой алгоритм оптимизации (Particle Swarm Optimization)
        function psoAlgorithm(startCity, destinations, planeCapacity, planeVolume) {
            // Параметры алгоритма
            const swarmSize = 50;
            const iterations = 100;
            const inertia = 0.7;
            const cognitiveWeight = 1.5;
            const socialWeight = 1.5;
            
            // Получаем данные о посылках
            const deliveries = Array.from(document.querySelectorAll('.delivery-item')).map(item => ({
                city: item.querySelector('.destination-city').value,
                weight: parseInt(item.querySelector('.weight').value),
                size: packageSizes[item.querySelector('.size').value]
            }));
            
            // Группируем посылки по городам
            const cityDeliveries = {};
            deliveries.forEach(delivery => {
                if (!cityDeliveries[delivery.city]) {
                    cityDeliveries[delivery.city] = {
                        weight: 0,
                        size: 0,
                        count: 0
                    };
                }
                cityDeliveries[delivery.city].weight += delivery.weight;
                cityDeliveries[delivery.city].size += delivery.size;
                cityDeliveries[delivery.city].count++;
            });
            
            const deliveryCities = Object.keys(cityDeliveries);
            
            // Генерация случайного маршрута
            function randomRoute() {
                const route = [...deliveryCities];
                // Shuffle only the intermediate cities
                for (let i = route.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [route[i], route[j]] = [route[j], route[i]];
                }
                // Always start and end at startCity
                return [startCity, ...route, startCity];
            }
            
            // Расчет стоимости маршрута (чем меньше, тем лучше)
            function calculateCost(route) {
                // Ensure route starts and ends at startCity
                if (route[0] !== startCity) route.unshift(startCity);
                if (route[route.length - 1] !== startCity) route.push(startCity);

                // Разделяем доставки на рейсы с учетом грузоподъемности и объема
                let flights = [];
                let currentFlight = {
                    cities: [startCity],
                    weight: 0,
                    volume: 0,
                    packages: 0
                };
                
                for (let i = 1; i < route.length - 1; i++) {
                    const city = route[i];
                    if (cityDeliveries[city]) {
                        const cityData = cityDeliveries[city];
                        
                        if (currentFlight.weight + cityData.weight <= planeCapacity &&
                            currentFlight.volume + cityData.size <= planeVolume) {
                            // Add city to current flight
                            currentFlight.cities.push(city);
                            currentFlight.weight += cityData.weight;
                            currentFlight.volume += cityData.size;
                            currentFlight.packages += cityData.count;
                        } else {
                            // Complete current flight and start new one
                            currentFlight.cities.push(startCity);
                            flights.push(currentFlight);
                            currentFlight = {
                                cities: [startCity, city],
                                weight: cityData.weight,
                                volume: cityData.size,
                                packages: cityData.count
                            };
                        }
                    } else {
                        // console.warn(`No delivery data found for city: ${city}`);
                    }
                }
                
                // Добавляем последний рейс
                if (currentFlight.cities.length > 1) {
                    currentFlight.cities.push(startCity);
                    flights.push(currentFlight);
                }
                
                // Рассчитываем общее расстояние
                let totalDistance = 0;
                flights.forEach(flight => {
                    flight.distance = 0;
                    for (let i = 0; i < flight.cities.length - 1; i++) {
                        flight.distance += distanceMatrix[flight.cities[i]][flight.cities[i+1]];
                    }
                    totalDistance += flight.distance;
                });
                
                // Штрафуем за количество рейсов (чтобы алгоритм старался минимизировать их)
                const flightsPenalty = flights.length * 500; // 500 км штрафа за каждый дополнительный рейс
                
                return {
                    cost: totalDistance + flightsPenalty,
                    flights: flights
                };
            }
            
            // Инициализация роя
            let swarm = [];
            let globalBest = { route: null, cost: Infinity, flights: [] };
            
            for (let i = 0; i < swarmSize; i++) {
                const route = randomRoute();
                const result = calculateCost(route);
                
                const particle = {
                    route: route,
                    cost: result.cost,
                    bestRoute: [...route],
                    bestCost: result.cost,
                    velocity: Array(route.length).fill(0),
                    flights: result.flights
                };
                
                swarm.push(particle);
                
                if (result.cost < globalBest.cost) {
                    globalBest.route = [...route];
                    globalBest.cost = result.cost;
                    globalBest.flights = result.flights;
                }
            }
            
            // Основной цикл алгоритма
            for (let iter = 0; iter < iterations; iter++) {
                for (const particle of swarm) {
                    // Обновляем скорость
                    for (let i = 0; i < particle.velocity.length; i++) {
                        const r1 = Math.random();
                        const r2 = Math.random();
                        
                        particle.velocity[i] = inertia * particle.velocity[i] +
                            cognitiveWeight * r1 * (particle.bestRoute[i] !== particle.route[i] ? 1 : 0) +
                            socialWeight * r2 * (globalBest.route[i] !== particle.route[i] ? 1 : 0);
                    }
                    
                    // Обновляем позицию (маршрут)
                    const newRoute = [...particle.route];
                    for (let i = 1; i < newRoute.length - 1; i++) {  // Skip first and last elements
                        if (Math.random() < particle.velocity[i]) {
                            // Only swap intermediate cities
                            const j = Math.floor(Math.random() * (newRoute.length - 2)) + 1;
                            [newRoute[i], newRoute[j]] = [newRoute[j], newRoute[i]];
                        }
                    }
                    
                    // Проверяем новый маршрут
                    const newResult = calculateCost(newRoute);
                    
                    if (newResult.cost < particle.bestCost) {
                        particle.bestRoute = [...newRoute];
                        particle.bestCost = newResult.cost;
                        particle.flights = newResult.flights;
                    }
                    
                    if (newResult.cost < globalBest.cost) {
                        globalBest.route = [...newRoute];
                        globalBest.cost = newResult.cost;
                        globalBest.flights = newResult.flights;
                    }
                    
                    particle.route = newRoute;
                    particle.cost = newResult.cost;
                    particle.flights = newResult.flights;
                }
            }
            
            return globalBest;
        }
                
        // Построение маршрута
        function buildRoute() {
            const startCity = document.getElementById('start-city').value;
            const planeCapacity = parseInt(document.getElementById('plane-capacity').value);
            const planeVolume = parseInt(document.getElementById('plane-volume').value);
            const algorithm = document.getElementById('algorithm').value;
            
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('results').classList.add('hidden');
            clearMap();
            
            setTimeout(() => {
                let result;
                
                if (algorithm === 'pso') {
                    result = psoAlgorithm(startCity, [], planeCapacity, planeVolume);
                } else {
                    result = greedyAlgorithm(startCity, [], planeCapacity, planeVolume);
                }
                
                // Ensure we have a valid route before visualization
                if (result && result.route && result.route.length) {
                    visualizeRoute(result.route);
                    showResults(result, planeCapacity, planeVolume);
                } else {
                    console.error("Failed to generate valid route");
                    document.getElementById('optimal-route').textContent = "Не удалось построить маршрут";
                    document.getElementById('results').classList.remove('hidden');
                }
                
                document.getElementById('loading').classList.add('hidden');
            }, 1500);
        }

        // Простой жадный алгоритм (в качестве альтернативы)
        function greedyAlgorithm(startCity, destinations, planeCapacity, planeVolume) {
            const deliveries = Array.from(document.querySelectorAll('.delivery-item')).map(item => ({
                city: item.querySelector('.destination-city').value,
                weight: parseInt(item.querySelector('.weight').value),
                size: packageSizes[item.querySelector('.size').value]
            }));

            // Group deliveries by city
            const cityDeliveries = {};
            deliveries.forEach(delivery => {
                if (!cityDeliveries[delivery.city]) {
                    cityDeliveries[delivery.city] = {
                        weight: 0,
                        size: 0,
                        count: 0
                    };
                }
                cityDeliveries[delivery.city].weight += delivery.weight;
                cityDeliveries[delivery.city].size += delivery.size;
                cityDeliveries[delivery.city].count++;
            });

            const deliveryCities = Object.keys(cityDeliveries);

            // Simple greedy approach - sort by distance from start city
            const sortedCities = [...deliveryCities].sort((a, b) => {
                return distanceMatrix[startCity][a] - distanceMatrix[startCity][b];
            });

            // Build flights considering capacity and volume
            let flights = [];
            let currentFlight = {
                cities: [startCity],
                weight: 0,
                volume: 0,
                packages: 0
            };

            for (const city of sortedCities) {
                const cityData = cityDeliveries[city];
                
                if (currentFlight.weight + cityData.weight <= planeCapacity &&
                    currentFlight.volume + cityData.size <= planeVolume) {
                    currentFlight.cities.push(city);
                    currentFlight.weight += cityData.weight;
                    currentFlight.volume += cityData.size;
                    currentFlight.packages += cityData.count;
                } else {
                    currentFlight.cities.push(startCity);
                    flights.push(currentFlight);
                    currentFlight = {
                        cities: [startCity, city],
                        weight: cityData.weight,
                        volume: cityData.size,
                        packages: cityData.count
                    };
                }
            }

            // Add last flight
            if (currentFlight.cities.length > 1) {
                currentFlight.cities.push(startCity);
                flights.push(currentFlight);
            }

            // Calculate total route (for visualization)
            const totalRoute = [startCity];
            flights.forEach(flight => {
                totalRoute.push(...flight.cities.slice(1, -1));
            });
            totalRoute.push(startCity);

            return {
                route: totalRoute,
                flights: flights,
                cost: flights.reduce((sum, flight) => {
                    flight.distance = 0;
                    for (let i = 0; i < flight.cities.length - 1; i++) {
                        flight.distance += distanceMatrix[flight.cities[i]][flight.cities[i+1]];
                    }
                    return sum + flight.distance;
                }, 0)
            };
        }

        // Очистка карты от предыдущих маршрутов
        function clearMap() {
            const map = document.getElementById('map');
            const lines = map.querySelectorAll('.route-line, .plane-icon');
            lines.forEach(el => el.remove());
        }

        // Визуализация маршрута на карте
        function visualizeRoute(route) {
            // Ensure route is valid
            if (!route || !route.length) {
                console.error("Invalid route provided for visualization");
                return;
            }

            const map = document.getElementById('map');
            if (!map.project) {
                console.error("Map projection function not found");
                return;
            }

            const project = map.project;
            
            // Clear previous routes
            clearMap();

            // Draw route lines
            for (let i = 0; i < route.length - 1; i++) {
                const fromCity = cities.find(c => c.name === route[i]);
                const toCity = cities.find(c => c.name === route[i+1]);
                
                if (fromCity && toCity) {
                    const fromPos = project(fromCity.lng, fromCity.lat);
                    const toPos = project(toCity.lng, toCity.lat);
                    
                    // Create route line
                    const line = document.createElement('div');
                    line.className = 'route-line';
                    
                    // Calculate line length and angle
                    const dx = toPos.x - fromPos.x;
                    const dy = toPos.y - fromPos.y;
                    const length = Math.sqrt(dx * dx + dy * dy);
                    const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                    
                    // Set line styles
                    line.style.width = `${length}px`;
                    line.style.left = `${fromPos.x}px`;
                    line.style.top = `${fromPos.y}px`;
                    line.style.transform = `rotate(${angle}deg)`;
                    
                    map.appendChild(line);
                }
            }
            
            // Add plane animation if route has at least 2 points
            if (route.length >= 2) {
                const plane = document.createElement('div');
                plane.className = 'plane-icon';
                map.appendChild(plane);
                animatePlane(plane, route, 0);
            }
        }

        // Анимация движения самолета по маршруту
        function animatePlane(plane, route, index) {
            if (index >= route.length - 1) return;
            
            const map = document.getElementById('map');
            const project = map.project;
            
            const fromCity = cities.find(c => c.name === route[index]);
            const toCity = cities.find(c => c.name === route[index+1]);
            
            if (!fromCity || !toCity) return;
            
            const fromPos = project(fromCity.lng, fromCity.lat);
            const toPos = project(toCity.lng, toCity.lat);
            
            const duration = 1000; // Продолжительность анимации между городами (мс)
            const startTime = performance.now();
            
            function step(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // Позиция самолета
                const x = fromPos.x + (toPos.x - fromPos.x) * progress;
                const y = fromPos.y + (toPos.y - fromPos.y) * progress;
                
                plane.style.left = `${x}px`;
                plane.style.top = `${y}px`;
                
                // Угол поворота самолета
                const dx = toPos.x - fromPos.x;
                const dy = toPos.y - fromPos.y;
                const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                plane.style.transform = `translate(-50%, -50%) rotate(${angle}deg)`;
                
                if (progress < 1) {
                    requestAnimationFrame(step);
                } else {
                    // Переходим к следующему отрезку маршрута
                    animatePlane(plane, route, index + 1);
                }
            }
            
            requestAnimationFrame(step);
        }

        // Показ результатов расчета
        function showResults(result, planeCapacity, planeVolume) {
            const flights = result.flights;
            
            // Рассчитываем общий вес и объем
            const totalWeight = flights.reduce((sum, flight) => sum + flight.weight, 0);
            const totalVolume = flights.reduce((sum, flight) => sum + flight.volume, 0);
            
            // Рассчитываем общее расстояние
            const totalDistance = flights.reduce((sum, flight) => sum + flight.distance, 0);
            
            // Общее время доставки
            const avgSpeed = 500; // км/ч
            const processingTime = 1; // час на аэропорт
            const totalTime = flights.reduce((sum, flight) => {
                return sum + (flight.distance / avgSpeed) + (flight.cities.length * processingTime);
            }, 0);
            
            // Примерная стоимость
            const costPerKm = document.getElementById('flight-cost').value;
            const totalCost = flights.reduce((sum, flight) => sum + flight.distance * costPerKm, 0);
            
            // Форматируем маршрут для отображения
            const formattedRoute = flights.map((flight, idx) => {
                return `Рейс ${idx+1}: ${flight.cities.join(' → ')} (${flight.distance} км, ${flight.weight} кг, ${flight.volume.toFixed(1)} м³)`;
            }).join('<br>');
            
            // Заполняем результаты
            document.getElementById('total-weight').textContent = totalWeight;
            document.getElementById('flights-count').textContent = flights.length;
            document.getElementById('total-distance').textContent = totalDistance;
            document.getElementById('delivery-time').textContent = Math.round(totalTime * 10) / 10;
            document.getElementById('delivery-cost').textContent = totalCost.toLocaleString('ru-RU');
            document.getElementById('optimal-route').innerHTML = formattedRoute;
            
            // Показываем блок результатов
            document.getElementById('results').classList.remove('hidden');
        }

        // Инициализация приложения при загрузке страницы
        document.addEventListener('DOMContentLoaded', () => {
            initDistanceMatrix();
            initUI();
        });
    </script>
</body>
</html>